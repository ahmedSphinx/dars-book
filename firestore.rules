rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check ownership
    function isOwner(data) {
      return request.auth != null && data.ownerId == request.auth.uid;
    }
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Teachers collection
    match /teachers/{teacherId} {
      allow read, write: if isAuthenticated() && teacherId == request.auth.uid;
      
      // Students subcollection
      match /students/{studentId} {
        allow read, write: if isAuthenticated() && 
                              resource.data.ownerId == request.auth.uid;
      }
      
      // Prices subcollection
      match /prices/{yearId} {
        allow read, write: if isAuthenticated() && 
                              resource.data.ownerId == request.auth.uid;
      }
      
      // Sessions subcollection
      match /sessions/{sessionId} {
        allow read, write: if isAuthenticated() && 
                              resource.data.ownerId == request.auth.uid;
        
        // Attendances subcollection
        match /attendances/{attendanceId} {
          allow read, write: if isAuthenticated() && 
                                resource.data.ownerId == request.auth.uid;
        }
      }
      
      // Session templates subcollection
      match /session_templates/{templateId} {
        allow read, write: if isAuthenticated() && 
                              resource.data.ownerId == request.auth.uid;
      }
      
      // Payments subcollection
      match /payments/{paymentId} {
        allow read, write: if isAuthenticated() && 
                              resource.data.ownerId == request.auth.uid;
      }
      
      // Metrics subcollections
      match /metrics_daily/{dateId} {
        allow read: if isAuthenticated() && 
                       resource.data.ownerId == request.auth.uid;
        allow write: if false; // Only cloud functions can write
      }
      
      match /metrics_monthly/{monthId} {
        allow read: if isAuthenticated() && 
                       resource.data.ownerId == request.auth.uid;
        allow write: if false; // Only cloud functions can write
      }
    }
    
    // Vouchers collection (admin/functions only)
    match /vouchers/{voucherId} {
      allow read, write: if false; // Only cloud functions can access
    }
  }
}

